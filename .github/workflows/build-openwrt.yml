name: ğŸ”§ Build ImmortalWrt x86-64

on:
  workflow_dispatch: # å…è®¸åœ¨ GitHub ç½‘é¡µæ‰‹åŠ¨è§¦å‘ç¼–è¯‘
  push:
    branches: [ main, master ] # å½“å‘ä¸»åˆ†æ”¯æ¨é€ä»£ç æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆå¯é€‰ï¼‰
  schedule:
    - cron: '0 2 * * 0' # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç¼–è¯‘ï¼ˆå¯é€‰ï¼ŒUTCæ—¶é—´ï¼‰

env:
  # --- æ ¸å¿ƒé…ç½®ï¼Œå¿…é¡»ä¿®æ”¹ ---
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-25.12
  # --- å›ºä»¶é…ç½® ---
  TARGET: x86
  SUBTARGET: 64
  TARGET_PROFILE: generic
  # --- åŠŸèƒ½å¼€å…³ ---
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ubuntu:22.04
    defaults:
      run:
        working-directory: /home/build/openwrt

    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºæœ¬ä»“åº“ä»£ç ï¼ˆè·å–æœ¬æ–‡ä»¶åŠä¸‹é¢çš„ diy è„šæœ¬ã€configï¼‰
    - name: ğŸšš Checkout Repository
      uses: actions/checkout@v4
      with:
        path: repository

    # æ­¥éª¤2ï¼šå‡†å¤‡ç¼–è¯‘ç¯å¢ƒä¸ä¾èµ–
    - name: âš™ï¸ Setup Build Environment
      run: |
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
          gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 \
          libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch \
          pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils \
          rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev zstd jq rename
        apt-get clean

    # æ­¥éª¤3ï¼šå…‹éš† ImmortalWrt æºç 
    - name: ğŸ“¥ Clone Source Code
      run: |
        git clone $REPO_URL -b $REPO_BRANCH /home/build/openwrt
        cd /home/build/openwrt
        # åº”ç”¨è‡ªå®šä¹‰ feeds é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        [ -f /home/build/repository/feeds.conf.custom ] && cp /home/build/repository/feeds.conf.custom feeds.conf.default

    - name: ğŸ” Debug - List Files
      run: |
        pwd
        ls -la
        echo "=== æ£€æŸ¥ä»“åº“æ–‡ä»¶ ==="
        find $GITHUB_WORKSPACE -type f -name "*.sh" -o -name ".config" | head -20

    - name: ğŸ” Debug - Verify Env
      run: |
        echo "=== æ£€æŸ¥åŸºç¡€å‘½ä»¤ ==="
        which bash make git gcc
        echo "=== æ£€æŸ¥ç›®å½• ==="
        ls -la /home/build/openwrt || echo "openwrtç›®å½•å¯èƒ½è¿˜ä¸å­˜åœ¨"
        
    # æ­¥éª¤4ï¼šæ‰§è¡Œç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬
    - name: ğŸ”¨ Run DIY Script Part 1
      run: |
        cd /home/build/openwrt
        if [ -f /home/build/repository/diy-part1.sh ]; then
          chmod +x /home/build/repository/diy-part1.sh
          /home/build/repository/diy-part1.sh
        fi

    # æ­¥éª¤5ï¼šæ›´æ–°å¹¶å®‰è£…æ‰€æœ‰è½¯ä»¶åŒ…æº
    - name: ğŸ“¦ Update and Install Feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # æ­¥éª¤6ï¼šæ‰§è¡Œç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬å¹¶åº”ç”¨é…ç½®æ–‡ä»¶
    - name: ğŸ”¨ Run DIY Script Part 2 & Load Config
      run: |
        # åº”ç”¨é…ç½®æ–‡ä»¶
        [ -f /home/build/repository/.config ] && cp /home/build/repository/.config .config
        # åº”ç”¨è‡ªå®šä¹‰æ–‡ä»¶ï¼ˆå¦‚ç½‘ç»œã€é˜²ç«å¢™é…ç½®ï¼‰
        [ -d /home/build/repository/files ] && cp -rf /home/build/repository/files/* files/
        # è¿è¡Œç¬¬äºŒé˜¶æ®µè„šæœ¬
        if [ -f /home/build/repository/diy-part2.sh ]; then
          chmod +x /home/build/repository/diy-part2.sh
          /home/build/repository/diy-part2.sh
        fi

    # æ­¥éª¤7ï¼šä¸‹è½½è½¯ä»¶åŒ…
    - name: â¬ Download Packages
      run: |
        make defconfig
        make download -j$(nproc)
        # æ£€æŸ¥å¹¶é‡æ–°ä¸‹è½½æŸåçš„åŒ…
        find dl -size -1024c -delete

    # æ­¥éª¤8ï¼šå¼€å§‹ç¼–è¯‘å›ºä»¶
    - name: ğŸ”¥ Start Compilation
      timeout-minutes: 180 # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…å ç”¨è¿‡é•¿æ—¶é—´
      run: |
        echo "å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹..."
        make -j$(nproc) V=s 2>&1 | tee compile.log || {
          echo "å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          make -j1 V=s 2>&1 | tee -a compile.log
        }

    # æ­¥éª¤9ï¼šæ•´ç†ç¼–è¯‘äº§ç‰©
    - name: ğŸ“¦ Organize Firmware Files
      if: success()
      run: |
        FIRMWARE_DIR=$(find bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }} -name "*${{ env.TARGET_PROFILE }}*" -type d | head -1)
        if [ -n "$FIRMWARE_DIR" ]; then
          echo "FIRMWARE_PATH=$FIRMWARE_DIR" >> $GITHUB_ENV
          cd $FIRMWARE_DIR
          rm -rf packages  # ç§»é™¤è½¯ä»¶åŒ…ç›®å½•ï¼Œä»…ä¿ç•™å›ºä»¶
          echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh
        else
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°å›ºä»¶ç›®å½•ï¼"
          exit 1
        fi

    # æ­¥éª¤10ï¼šä¸Šä¼ å›ºä»¶ä¸º Artifactï¼ˆå¯ç›´æ¥ä¸‹è½½ï¼‰
    - name: â¬†ï¸ Upload Firmware as Artifact
      if: env.UPLOAD_FIRMWARE == 'true' && success()
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt_x86-64_Firmware
        path: ${{ env.FIRMWARE_PATH }}/*.img.gz
        retention-days: 7

    # æ­¥éª¤11ï¼šåˆ›å»º GitHub Release å¹¶ä¸Šä¼ å›ºä»¶
    - name: ğŸ·ï¸ Create Release and Upload
      if: env.UPLOAD_RELEASE == 'true' && success()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: build-${{ github.run_number }}-$(date +'%Y%m%d')
        name: ImmortalWrt x86-64 Build #${{ github.run_number }} ($(date +'%Y-%m-%d'))
        body: |
          åŸºäº ImmortalWrt ${{ env.REPO_BRANCH }} åˆ†æ”¯è‡ªåŠ¨ç¼–è¯‘çš„ x86-64 å›ºä»¶ã€‚
          **æ„å»ºä¿¡æ¯**:
          - ç‰ˆæœ¬: ImmortalWrt ${{ env.REPO_BRANCH }}
          - å†…æ ¸: 6.12
          - æ„å»ºæ—¥æœŸ: $(date)
          - è¿è¡Œç¼–å·: #${{ github.run_number }}
          **åŒ…å«æ’ä»¶**:
          - ç½‘ç»œå¢å¼º: AdGuardHome, OpenClash, PassWall, TurboACC, UPNP
          - ç³»ç»Ÿå·¥å…·: Dockerman, AutoUpdate, CPU Freq, å¸¦å®½ç›‘æ§
          - æ–‡ä»¶å…±äº«: Samba4, USBæ‰“å°æœº
          - å®‰å…¨é˜²æŠ¤: AppFilter, Adbyby+, Fail2ban
          - ä¸»é¢˜: Argon, Material
        draft: false
        prerelease: false
        files: ${{ env.FIRMWARE_PATH }}/*.img.gz
