name: 极速构建 OpenWrt (Docker ImageBuilder)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: '是否启用 SSH'
        required: false
        default: 'false'
      version:
        description: '版本标签'
        required: false
        default: '25.12'
        type: string
      profile:
        description: '设备 Profile'
        required: false
        default: 'generic'
        type: string

env:
  DOCKER_IMAGE: openwrt/imagebuilder:x86-64-openwrt-25.12
  CONFIG_FILE: x86_64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ${{ env.DOCKER_IMAGE }}
      options: --user root --network host
    env:
      KERNEL_PARTSIZE: 16
      ROOTFS_PARTSIZE: 1024

    steps:
    - name: 检查本仓库
      uses: actions/checkout@v4
      with:
        path: workspace

    - name: 初始化环境
      run: |
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "VERSION=${{ github.event.inputs.version || '25.12' }}" >> $GITHUB_ENV
        echo "PROFILE=${{ github.event.inputs.profile || 'generic' }}" >> $GITHUB_ENV
        
        mkdir -p /home/build
        mkdir -p workspace/files
        chmod -R 777 /home/build workspace

    - name: 显示容器信息
      run: |
        echo "===== 容器信息 ====="
        echo "镜像: ${{ env.DOCKER_IMAGE }}"
        echo "版本: ${{ env.VERSION }}"
        echo "Profile: ${{ env.PROFILE }}"

    - name: 执行自定义脚本 (DIY)
      working-directory: /__w/$(basename ${{ github.repository }})/$(basename ${{ github.repository }})/workspace
      run: |
        if [ -f "$DIY_P1_SH" ]; then
          echo "执行 $DIY_P1_SH"
          chmod +x "$DIY_P1_SH"
          ./"$DIY_P1_SH"
        else
          echo "未找到 $DIY_P1_SH"
        fi
        
        if [ -f "$DIY_P2_SH" ]; then
          echo "执行 $DIY_P2_SH"
          chmod +x "$DIY_P2_SH"
          ./"$DIY_P2_SH"
        else
          echo "未找到 $DIY_P2_SH"
        fi

    - name: 查找并进入 ImageBuilder 目录
      id: locate_ib
      run: |
        IB_DIR=""
        
        for path in "/builder" "/home/build" "/imagebuilder" "/opt/imagebuilder"; do
          if [ -d "$path" ] && [ -f "$path/Makefile" ]; then
            IB_DIR="$path"
            echo "找到 ImageBuilder 目录: $IB_DIR"
            break
          fi
        done
        
        if [ -z "$IB_DIR" ]; then
          echo "搜索 Makefile..."
          found_makefile=$(find / -name "Makefile" -type f 2>/dev/null | grep -v ".git" | grep -v "node_modules" | head -1)
          if [ -n "$found_makefile" ]; then
            IB_DIR=$(dirname "$found_makefile")
            echo "通过 Makefile 找到目录: $IB_DIR"
          fi
        fi
        
        if [ -z "$IB_DIR" ]; then
          echo "::error::未找到 ImageBuilder 目录"
          exit 1
        fi
        
        echo "ImageBuilder 目录: $IB_DIR"
        cd "$IB_DIR"
        echo "当前目录: $(pwd)"
        echo "ib_dir=$IB_DIR" >> $GITHUB_ENV

    - name: 准备配置文件
      id: prepare_config
      working-directory: /__w/$(basename ${{ github.repository }})/$(basename ${{ github.repository }})/workspace
      run: |
        if [ -f "$CONFIG_FILE" ]; then
          echo "使用自定义配置文件: $CONFIG_FILE"
          cp "$CONFIG_FILE" "$IB_DIR/.config"
        else
          echo "生成默认配置文件"
          cat > "$IB_DIR/.config" << EOF
      CONFIG_TARGET_x86=y
      CONFIG_TARGET_x86_64=y
      CONFIG_TARGET_x86_64_DEVICE_${{ env.PROFILE }}=y
      CONFIG_TARGET_IMAGES_GZIP=y
      CONFIG_VMDK_IMAGES=y
      CONFIG_GRUB_IMAGES=y
      EOF
          
          if [ "${{ github.event.inputs.ssh }}" == "true" ]; then
            echo "CONFIG_PACKAGE_dropbear=y" >> "$IB_DIR/.config"
            echo "CONFIG_DROPBEAR_ED25519=y" >> "$IB_DIR/.config"
          fi
        fi

    - name: 解析包列表
      id: parse_packages
      working-directory: ${{ env.ib_dir }}
      run: |
        echo "解析配置文件..."
        
        PACKAGES=$(grep '^CONFIG_PACKAGE_' .config | grep '=y' | sed 's/CONFIG_PACKAGE_//;s/=y//' | tr '\n' ' ')
        PACKAGE_COUNT=$(echo $PACKAGES | wc -w)
        
        echo "包数量: $PACKAGE_COUNT"
        echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV
        echo "PACKAGE_COUNT=$PACKAGE_COUNT" >> $GITHUB_ENV

    - name: 极速生成固件
      id: compile
      working-directory: ${{ env.ib_dir }}
      run: |
        echo "开始构建..."
        echo "Profile: ${{ env.PROFILE }}"
        echo "Kernel Partsize: $KERNEL_PARTSIZE MB"
        echo "Rootfs Partsize: $ROOTFS_PARTSIZE MB"
        
        make image \
          PROFILE="${{ env.PROFILE }}" \
          PACKAGES="$PACKAGES" \
          FILES="/__w/$(basename ${{ github.repository }})/$(basename ${{ github.repository }})/workspace/files" \
          BIN_DIR="/__w/$(basename ${{ github.repository }})/$(basename ${{ github.repository }})/workspace/bin" \
          KERNEL_PARTSIZE=$KERNEL_PARTSIZE \
          ROOTFS_PARTSIZE=$ROOTFS_PARTSIZE
        
        if [ $? -eq 0 ]; then
          echo "构建成功!"
        else
          echo "::error::构建失败"
          exit 1
        fi
        
        echo "DEVICE_NAME=x86_64" >> $GITHUB_ENV

    - name: 整理构建产物
      working-directory: /__w/$(basename ${{ github.repository }})/$(basename ${{ github.repository }})/workspace
      run: |
        echo "整理产物..."
        mkdir -p artifacts
        
        if [ -d "bin/targets/x86/64" ]; then
          cp -r bin/targets/x86/64/* artifacts/
        elif [ -d "bin/targets" ]; then
          find bin/targets -type f \( -name "*.img.gz" -o -name "*.img" -o -name "*.iso" -o -name "*.vmdk" -o -name "*.qcow2" -o -name "*.sha256sums" -o -name "*.manifest" \) -exec cp {} artifacts/ \;
        fi
        
        cd artifacts
        for file in *; do
          if [ -f "$file" ] && [[ ! "$file" == *.sha256sums ]] && [[ ! "$file" == *.manifest ]]; then
            sha256sum "$file" > "$file.sha256"
          fi
        done
        
        echo "产物准备完成"

    - name: 发布到 Release
      uses: softprops/action-gh-release@v1
      if: env.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: OpenWrt-25.12-x86_64-${{ env.PROFILE }}-${{ env.FILE_DATE }}
        name: OpenWrt 25.12 x86_64 [${{ env.PROFILE }}] [${{ env.FILE_DATE }}]
        body: |
          # OpenWrt 25.12 固件
          
          **版本信息:**
          - OpenWrt 版本: 25.12 (自定义/开发版)
          - 架构: x86_64
          - 设备 Profile: ${{ env.PROFILE }}
          - 构建时间: ${{ env.FILE_DATE::8 }} 
          
          **构建配置:**
          - 内核分区: ${KERNEL_PARTSIZE}MB
          - 根文件系统分区: ${ROOTFS_PARTSIZE}MB
          - 包含软件包: ${{ env.PACKAGE_COUNT }} 个
          - SSH 访问: ${{ github.event.inputs.ssh == 'true' && '已启用' || '未启用' }}
          
          **默认网络:**
          - 管理地址: 192.168.6.1
          - 用户名: root
          - 密码: （无默认密码）
          
          **使用说明:**
          1. 将 .img.gz 文件解压后写入 USB 或硬盘
          2. 首次启动需要设置 root 密码
          3. 通过浏览器访问 https://192.168.6.1 进行配置
          
          **文件说明:**
          - .img.gz: 压缩磁盘镜像
          - .img: 原始磁盘镜像
          - .vmdk: VMware 虚拟磁盘
          - .sha256: SHA256 校验文件
          - .manifest: 包清单
          
          **注意事项:**
          - 此版本为 25.12，非官方稳定版
          - 建议在虚拟机或测试环境中使用
          - 如需帮助，请提供详细的错误信息
        files: workspace/artifacts/*
        draft: false
        prerelease: true

    - name: 上传构建日志
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: |
          ${{ env.ib_dir }}/logs/
          workspace/artifacts/*.manifest
        retention-days: 7

    - name: 显示构建摘要
      if: always()
      run: |
        echo "===== 构建摘要 ====="
        echo "状态: ${{ job.status }}"
        echo "版本: ${{ env.VERSION }}"
        echo "Profile: ${{ env.PROFILE }}"
        echo "构建时间: ${{ env.FILE_DATE }}"
        echo "包数量: ${{ env.PACKAGE_COUNT }}"
        echo "SSH: ${{ github.event.inputs.ssh }}"
        echo "管理地址: 192.168.6.1"
