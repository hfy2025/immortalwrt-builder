name: 极速构建 ImmortalWrt (Docker ImageBuilder)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: '是否启用 SSH'
        required: false
        default: 'false'

env:
  DOCKER_IMAGE: openwrt/imagebuilder:x86-64-openwrt-25.12
  CONFIG_FILE: x86_64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: openwrt/imagebuilder:x86-64-openwrt-25.12
      options: --user root
    env:
      KERNEL_PARTSIZE: 16
      ROOTFS_PARTSIZE: 1024

    steps:
    - name: 检查本仓库
      uses: actions/checkout@v3

    - name: 初始化环境
      shell: bash
      run: |
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        mkdir -p files

    - name: 执行自定义脚本 (DIY)
      shell: bash
      run: |
        chmod +x $DIY_P1_SH $DIY_P2_SH
        ./$DIY_P1_SH
        ./$DIY_P2_SH

    - name: 极速生成固件
      id: compile
      shell: bash
      run: |
        # 1. 自动定位 ImageBuilder 目录 (优化探测逻辑，杜绝语法错误)
        IB_DIR=""
        if [ -f "/builder/Makefile" ]; then
            IB_DIR="/builder"
        else
            # 搜索当前容器内所有的 Makefile 并取第一个所在的目录
            MAPFILE=($(find /home/build -name "Makefile" 2>/dev/null))
            if [ ${#MAPFILE[@]} -gt 0 ]; then
                IB_DIR=$(dirname "${MAPFILE[0]}")
            fi
        fi

        if [ -z "$IB_DIR" ]; then
            echo "::error::未能在容器中找到构建所需的 Makefile"
            exit 1
        fi

        echo "定位到构建目录: $IB_DIR"
        cd "$IB_DIR"

        # 2. 准备配置文件
        if [ -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
            cp "$GITHUB_WORKSPACE/$CONFIG_FILE" .config
        else
            echo "CONFIG_TARGET_x86=y" > .config
            echo "CONFIG_TARGET_x86_64=y" >> .config
        fi

        # 3. 解析包列表 (单行处理，增强稳定性)
        PACKAGES=$(grep '^CONFIG_PACKAGE_' .config | grep '=y' | sed 's/CONFIG_PACKAGE_//;s/=y//' | xargs echo)
        echo "待集成软件包: $PACKAGES"

        # 4. 执行构建 (合并为单行，杜绝反斜杠带来的空格风险)
        make image PROFILE="generic" PACKAGES="$PACKAGES" FILES="$GITHUB_WORKSPACE/files" KERNEL_PARTSIZE=$KERNEL_PARTSIZE ROOTFS_PARTSIZE=$ROOTFS_PARTSIZE

        # 5. 整理产物
        mkdir -p $GITHUB_WORKSPACE/bin/targets/x86/64/
        if [ -d "bin/targets" ]; then
            find bin/targets/ -type f ( -name "*.img.gz" -o -name "*.iso" -o -name "*.sha256sums" ) -exec cp {} $GITHUB_WORKSPACE/bin/targets/x86/64/ ;
        fi
        
        echo "DEVICE_NAME=x86_64" >> $GITHUB_ENV

    - name: 发布到 Release
      uses: softprops/action-gh-release@v1
      if: env.UPLOAD_RELEASE == 'true'
      with:
        tag_name: ImmortalWrt-x86_x86_64_${{ env.FILE_DATE }}
        name: ImmortalWrt-x86 极速发布 [${{ env.FILE_DATE }}]
        body: |
          编译完成！
          构建模式: Docker ImageBuilder (极速)
          管理地址: 192.168.6.1
          磁盘分区: 16M / 1024M
        files: bin/targets/x86/64/*
