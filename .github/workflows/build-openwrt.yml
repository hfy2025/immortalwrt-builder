name: ğŸ”§ Build ImmortalWrt x86-64

on:
  workflow_dispatch: # å…è®¸åœ¨ GitHub ç½‘é¡µæ‰‹åŠ¨è§¦å‘ç¼–è¯‘
  push:
    branches: [ main, master ] # å½“å‘ä¸»åˆ†æ”¯æ¨é€ä»£ç æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆå¯é€‰ï¼‰
  schedule:
    - cron: '0 2 * * 0' # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç¼–è¯‘ï¼ˆå¯é€‰ï¼ŒUTCæ—¶é—´ï¼‰

env:
  # --- æ ¸å¿ƒé…ç½®ï¼Œå¿…é¡»ä¿®æ”¹ ---
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-25.12
  # --- å›ºä»¶é…ç½® ---
  TARGET: x86
  SUBTARGET: 64
  TARGET_PROFILE: generic
  # --- åŠŸèƒ½å¼€å…³ ---
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºæœ¬ä»“åº“ä»£ç ï¼ˆè·å–æœ¬æ–‡ä»¶åŠä¸‹é¢çš„ diy è„šæœ¬ã€configï¼‰
    - name: ğŸšš Checkout Repository
      uses: actions/checkout@v4
      with:
        path: repository

    # æ­¥éª¤2ï¼šå‡†å¤‡ç¼–è¯‘ç¯å¢ƒä¸ä¾èµ–
    - name: âš™ï¸ Setup Build Environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
          gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 \
          libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch \
          pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils \
          rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev zstd jq rename
        sudo apt-get clean

    # æ­¥éª¤3ï¼šå…‹éš† ImmortalWrt æºç 
    - name: ğŸ“¥ Clone Source Code
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        echo "æºç å…‹éš†å®Œæˆï¼Œç›®å½•ä½äº: $(pwd)/openwrt"

    - name: ğŸ” DEBUG - Find The Bad Line
      run: |
        echo "=== å½“å‰ç›®å½• ==="
        pwd && ls -la
        echo "=== æœç´¢å¯èƒ½å¯¼è‡´é”™è¯¯çš„è¡Œ (åœ¨ .yml å’Œ .sh æ–‡ä»¶ä¸­) ==="
        # åœ¨å·¥ä½œæµæ–‡ä»¶ä¸­æœç´¢æ—§è·¯å¾„
        if [ -f .github/workflows/*.yml ]; then grep -n "/home/build/openwrt" .github/workflows/*.yml || echo "åœ¨.ymlæ–‡ä»¶ä¸­æœªæ‰¾åˆ°æ—§è·¯å¾„"; fi
        # åœ¨å¯èƒ½å­˜åœ¨çš„è„šæœ¬ä¸­æœç´¢æ—§è·¯å¾„
        if [ -f diy-part1.sh ]; then grep -n "/home/build/openwrt" diy-part1.sh || echo "åœ¨diy-part1.shä¸­æœªæ‰¾åˆ°æ—§è·¯å¾„"; fi
        if [ -f diy-part2.sh ]; then grep -n "/home/build/openwrt" diy-part2.sh || echo "åœ¨diy-part2.shä¸­æœªæ‰¾åˆ°æ—§è·¯å¾„"; fi
        echo "=== è°ƒè¯•ç»“æŸ ==="
        
    - name: ğŸ” Debug - List Files
      run: |
        pwd
        ls -la
        echo "=== æ£€æŸ¥ä»“åº“æ–‡ä»¶ ==="
        find $GITHUB_WORKSPACE -type f -name "*.sh" -o -name ".config" | head -20

    - name: ğŸ” Debug - Verify Env
      run: |
        echo "=== æ£€æŸ¥åŸºç¡€å‘½ä»¤ ==="
        which bash make git gcc
        echo "=== æ£€æŸ¥ç›®å½• ==="
        ls -la /home/build/openwrt || echo "openwrtç›®å½•å¯èƒ½è¿˜ä¸å­˜åœ¨"
        
    # æ­¥éª¤4ï¼šæ‰§è¡Œç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬
    - name: ğŸ”¨ Run DIY Script Part 1
      working-directory: ${{ github.workspace }}/openwrt
      run: |
        # è„šæœ¬ä¼šåœ¨æ­£ç¡®çš„ openwrt ç›®å½•ä¸‹æ‰§è¡Œï¼Œæ— éœ€å† cd
        if [ -f ${{ github.workspace }}/repository/diy-part1.sh ]; then
          cp ${{ github.workspace }}/repository/diy-part1.sh .
          chmod +x diy-part1.sh
          ./diy-part1.sh
        fi
        
    # æ­¥éª¤5ï¼šæ›´æ–°å¹¶å®‰è£…æ‰€æœ‰è½¯ä»¶åŒ…æº
    - name: ğŸ“¦ Update and Install Feeds
      working-directory: ${{ github.workspace }}/openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # æ­¥éª¤6ï¼šæ‰§è¡Œç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬å¹¶åº”ç”¨é…ç½®æ–‡ä»¶
    - name: ğŸ”¨ Run DIY Script Part 2 & Load Config
      working-directory: ${{ github.workspace }}/openwrt
      run: |
        # åº”ç”¨é…ç½®æ–‡ä»¶
        [ -f ${{ github.workspace }}/.config ] && cp ${{ github.workspace }}/.config .config
        # è¿è¡Œç¬¬äºŒé˜¶æ®µè„šæœ¬
        if [ -f ${{ github.workspace }}/repository/diy-part2.sh ]; then
          cp ${{ github.workspace }}/repository/diy-part2.sh .
          chmod +x diy-part2.sh
          ./diy-part2.sh
        fi

    # æ­¥éª¤7ï¼šä¸‹è½½è½¯ä»¶åŒ…
    - name: â¬ Download Packages
      working-directory: ${{ github.workspace }}/openwrt
      run: |
        echo â€œ=== æ­¥éª¤1: å¤åˆ¶ç”¨æˆ·é…ç½® ==="
        cp ${{ github.workspace }}/.config .config 2>/dev/null || echo â€œè­¦å‘Šï¼šæœªæ‰¾åˆ°ç”¨æˆ·configï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®â€
        echo â€œ=== æ­¥éª¤2: ä½¿ç”¨ olddefconfig éäº¤äº’å¼è§£æä¾èµ– ==="
        make olddefconfig
        echo â€œ=== æ­¥éª¤3: ç¡®è®¤æœ€ç»ˆé…ç½®çš„ç›®æ ‡å¹³å° ==="
        echo â€œå½“å‰é…ç½®çš„ç›®æ ‡:â€
        grep ^CONFIG_TARGET_ .config || echo â€œ(æœªæ‰¾åˆ°ç›®æ ‡é…ç½®)â€
        echo â€œ=== æ­¥éª¤4: å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ… ==="
        make download -j$(nproc)
        echo â€œ=== æ­¥éª¤5: æ¸…ç†æ— æ•ˆçš„ä¸‹è½½ç¼“å­˜ ==="
        find dl -size -1024c -delete 2>/dev/null || true

    - name: ğŸ› ï¸ Debug with SSH (æ‰‹åŠ¨é…ç½®)
      if: false  # é»˜è®¤ä¸è¿è¡Œï¼Œéœ€è¦æ—¶æ”¹ä¸º true
      uses: mxschmitt/action-tmate@v3
  
    # æ­¥éª¤8ï¼šå¼€å§‹ç¼–è¯‘å›ºä»¶
    - name: ğŸ”¥ Start Compilation
      timeout-minutes: 180 # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…å ç”¨è¿‡é•¿æ—¶é—´
      run: |
        echo "å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹..."
        make -j$(nproc) V=s 2>&1 | tee compile.log || {
          echo "å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          echo "=== è°ƒè¯•ï¼šæ£€æŸ¥å½“å‰é…ç½®çš„ç›®æ ‡ ==="
          grep ^CONFIG_TARGET_ .config || echo "æ‰¾ä¸åˆ° .config æ–‡ä»¶"
          grep ^CONFIG_TARGET_ARCH .config || echo "æœªè®¾ç½®æ¶æ„"
          make -j1 V=s 2>&1 | tee -a compile.log
        }

    # æ­¥éª¤9ï¼šæ•´ç†ç¼–è¯‘äº§ç‰©
    - name: ğŸ“¦ Organize Firmware Files
      id: organize
      if: success() && env.UPLOAD_FIRMWARE == 'true'
      # å…³é”®ï¼šç¡®ä¿åœ¨ openwrt æºç æ ¹ç›®å½•ä¸‹æ‰§è¡Œ
      working-directory: ${{ github.workspace }}/openwrt
      run: |
        echo "å¼€å§‹æ•´ç†å›ºä»¶æ–‡ä»¶..."
        # 1. å®šä½å›ºä»¶ç›®å½•ï¼ˆä½¿ç”¨æ›´é€šç”¨çš„æŸ¥æ‰¾æ–¹å¼ï¼‰
        FIRMWARE_DIR=$(find bin/targets -type d -name "*${{ env.TARGET_PROFILE }}*" 2>/dev/null | head -1)
        
        if [ -z "$FIRMWARE_DIR" ]; then
          # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åˆ—å‡º targets ä¸‹æ‰€æœ‰ç›®å½•è¾…åŠ©è°ƒè¯•
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°åŒ…å« '${{ env.TARGET_PROFILE }}' çš„å›ºä»¶ç›®å½•ã€‚"
          echo "è°ƒè¯•ä¿¡æ¯ - bin/targets ç»“æ„ï¼š"
          find bin/targets -type d 2>/dev/null || echo "bin/targets ç›®å½•ä¸å­˜åœ¨"
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°å›ºä»¶ç›®å½•ï¼ç¼–è¯‘å¯èƒ½æœªæˆåŠŸç”Ÿæˆå›ºä»¶ã€‚"
          exit 1
        fi
        
        echo "æ‰¾åˆ°å›ºä»¶ç›®å½•ï¼š$FIRMWARE_DIR"
        cd "$FIRMWARE_DIR"
        # ç§»é™¤è½¯ä»¶åŒ…ç›®å½•ï¼Œä»…ä¿ç•™å›ºä»¶
        rm -rf packages 2>/dev/null || true
        echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -lh
        
        # è®¾ç½®è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "FIRMWARE_PATH=$(pwd)" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # æ­¥éª¤10ï¼šä¸Šä¼ å›ºä»¶ä¸º Artifactï¼ˆå¯ç›´æ¥ä¸‹è½½ï¼‰
    - name: â¬†ï¸ Upload Firmware as Artifact
      if: env.UPLOAD_FIRMWARE == 'true' && success()
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt_x86-64_Firmware
        path: ${{ env.FIRMWARE_PATH }}/*.img.gz
        retention-days: 7

    # æ­¥éª¤11ï¼šåˆ›å»º GitHub Release å¹¶ä¸Šä¼ å›ºä»¶
    - name: ğŸ·ï¸ Create Release and Upload
      if: env.UPLOAD_RELEASE == 'true' && success()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: build-${{ github.run_number }}-$(date +'%Y%m%d')
        name: ImmortalWrt x86-64 Build #${{ github.run_number }} ($(date +'%Y-%m-%d'))
        body: |
          åŸºäº ImmortalWrt ${{ env.REPO_BRANCH }} åˆ†æ”¯è‡ªåŠ¨ç¼–è¯‘çš„ x86-64 å›ºä»¶ã€‚
          **æ„å»ºä¿¡æ¯**:
          - ç‰ˆæœ¬: ImmortalWrt ${{ env.REPO_BRANCH }}
          - å†…æ ¸: 6.12
          - æ„å»ºæ—¥æœŸ: $(date)
          - è¿è¡Œç¼–å·: #${{ github.run_number }}
          **åŒ…å«æ’ä»¶**:
          - ç½‘ç»œå¢å¼º: AdGuardHome, OpenClash, PassWall, TurboACC, UPNP
          - ç³»ç»Ÿå·¥å…·: Dockerman, AutoUpdate, CPU Freq, å¸¦å®½ç›‘æ§
          - æ–‡ä»¶å…±äº«: Samba4, USBæ‰“å°æœº
          - å®‰å…¨é˜²æŠ¤: AppFilter, Adbyby+, Fail2ban
          - ä¸»é¢˜: Argon, Material
        draft: false
        prerelease: false
        files: ${{ env.FIRMWARE_PATH }}/*.img.gz
