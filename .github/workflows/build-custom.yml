name: 极速构建 ImmortalWrt (Docker ImageBuilder)

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: '是否启用 SSH'
        required: false
        default: 'false'

env:
  DOCKER_IMAGE: openwrt/imagebuilder:x86-64-openwrt-25.12
  CONFIG_FILE: seed.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: openwrt/imagebuilder:x86-64-openwrt-25.12
      options: --user root
    env:
      KERNEL_PARTSIZE: 16
      ROOTFS_PARTSIZE: 1024

    steps:
    - name: 检查本仓库
      uses: actions/checkout@v3

    - name: 初始化环境
      run: |
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        mkdir -p files

    - name: 执行自定义脚本 (DIY)
      run: |
        chmod +x $DIY_P1_SH $DIY_P2_SH
        ./$DIY_P1_SH
        ./$DIY_P2_SH

    - name: 极速生成固件
      id: compile
      run: |
        # 进入 ImageBuilder 根目录 (通常是 /builder)
        cd /builder
        
        # 将配置文件拷贝到编译目录
        [ -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ] && cp "$GITHUB_WORKSPACE/$CONFIG_FILE" .config
        
        # 解析 .config 中的包列表
        PACKAGES=$(grep '^CONFIG_PACKAGE_' .config | grep '=y' | sed 's/CONFIG_PACKAGE_//;s/=y//' | tr '\n' ' ')
        
        # 执行 ImageBuilder 核心命令
        # 显式传递分区大小环境变量，FILES 指向工作区的 files 目录
        make image PACKAGES="$PACKAGES" FILES="$GITHUB_WORKSPACE/files"            KERNEL_PARTSIZE=$KERNEL_PARTSIZE            ROOTFS_PARTSIZE=$ROOTFS_PARTSIZE
        
        # 将生成的固件拷贝回工作区以便后续发布
        mkdir -p $GITHUB_WORKSPACE/bin/targets/x86/64/
        cp -r bin/targets/x86/64/* $GITHUB_WORKSPACE/bin/targets/x86/64/
        
        echo "DEVICE_NAME=x86_64" >> $GITHUB_ENV

    - name: 发布到 Release
      uses: softprops/action-gh-release@v1
      if: env.UPLOAD_RELEASE == 'true'
      with:
        tag_name: ImmortalWrt_x86_64_${{ env.FILE_DATE }}
        name: ImmortalWrt 极速发布 [${{ env.FILE_DATE }}]
        body: |
          编译完成！
          构建模式: Docker ImageBuilder (极速)
          镜像版本: openwrt/imagebuilder:x86-64-openwrt-25.12
          管理地址: 192.168.6.1
          分区设置: 内核 ${{ env.KERNEL_PARTSIZE }}MB / 系统 ${{ env.ROOTFS_PARTSIZE }}MB
          包含插件: AdGuardHome, Nikki, TurboAcc, Lucky 等
        files: bin/targets/*/*/*
